name: Power BI Deployment with Dataset Parameter Update1

on:
  push:
    branches:
      - main

env:
  POWER_BI_CLIENT_ID: ${{secrets.POWER_BI_CLIENT_ID}}
  POWER_BI_CLIENT_SECRET: ${{secrets.POWER_BI_CLIENT_SECRET}}
  POWER_BI_TENANT_ID: ${{secrets.POWER_BI_TENANT_ID}}
  POWER_BI_WORKSPACE_ID: ${{secrets.POWER_BI_WORKSPACE_ID}}
  PBIX_FILE_PATH: ./devreport0001.pbix
  DATASET_NAME: devreport0001
  REPORT_NAME: devreport0001.pbix
  DOTNET_INSTALL_DIR: "runner/dotnet"

jobs:
  pbix_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3.0.3
        with:
          dotnet-version: 6.0.x

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Power BI CLI
        run: |
          npm i -g @powerbi-cli/powerbi-cli
      - name: Authenticate Power BI CLI
        run: |
          pbicli login --service-principal -p ${{env.POWER_BI_CLIENT_ID}} -s ${{env.POWER_BI_CLIENT_SECRET}} -t ${{env.POWER_BI_TENANT_ID}}
      - name: Import PBIX File
        run: |
          pbicli import pbix --workspace ${{env.POWER_BI_WORKSPACE_ID}} --file ${{env.PBIX_FILE_PATH}} --name ${{env.DATASET_NAME}} --conflict CreateOrOverwrite

      - name: Get Access Token
        env:
          GITHUB_PAT: ${{ secrets.PAT_TOKEN_GIT }}
        run: |
          # Use the GitHub PAT to authenticate with Azure AD and obtain an access token
          # Replace the placeholders with your Azure AD configuration
          AZURE_AD_TENANT_ID="0277ec7c-6485-4a45-9d8e-07a6941a7819"
          AZURE_AD_CLIENT_ID="647b60eb-374e-4af1-b7c7-439ba4913814"
          AZURE_AD_CLIENT_SECRET="peA8Q~TGozmsgvf8dT3CF16mDlTVvOUuCufJ_aDF"
          ACCESS_TOKEN=$(curl -X POST -d "grant_type=client_credentials" -d "client_id=$AZURE_AD_CLIENT_ID" -d "client_secret=$AZURE_AD_CLIENT_SECRET" -d "scope=https://analysis.windows.net/powerbi/api/.default" "https://login.microsoftonline.com/$AZURE_AD_TENANT_ID/oauth2/token" | jq -r .access_token)
          echo "POWER_BI_ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
          #pbicli rest --uri /v1.0/myorg/groups/96b1ab18-cd5e-4e01-8ffd-8bf59651f1bf/datasets/1e9f210c-d1b2-480c-8184-96c3938e1fef/Default.UpdateParameters --body -b @{parameter-values.json} --headers Authorization=Bearer ${{env.POWER_BI_ACCESS_TOKEN}} Content-Type=application/json --method POST --verbose
      

      - name: Update Dataset Parameters
        run: |
          # Here, update dataset parameters using the contents of your parameter file
          pbicli dataset parameter update --workspace ${{env.POWER_BI_WORKSPACE_ID}} --dataset ${{env.DATASET_NAME}} --parameter-file ./parameter-values.json --verbose
